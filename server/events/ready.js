const { Events } = require('discord.js');

module.exports = {
	name: Events.ClientReady,
	once: true,
	async execute(client) {
		console.log(`Ready! Logged in as ${client.user.tag}`);
		const guildChannel = client.channels.cache.get(GetResourceMetadata(GetCurrentResourceName(), 'DiscordStatusChannelId'));
		await guildChannel.bulkDelete(1).catch(e => console.warn('Failed to delete previous message - probably becuase there isn\'t one!'));
		let statusEmbed = new client.discord.EmbedBuilder()
			.setColor(0x0099FF)
			.setTitle(`${GetResourceMetadata(GetCurrentResourceName(), 'DiscordStatusEmbedTitle')} - Status`)
			.setURL(GetResourceMetadata(GetCurrentResourceName(), 'DiscordStatusEmbedURL'))
			.setAuthor({ name: `${client.user.username}`, iconURL: `${client.user.displayAvatarURL()}`, url: 'https://conceptcollective.net' })
			.setDescription('Server has been started <:checkmark:964881366099558481>')
			.setThumbnail(GetResourceMetadata(GetCurrentResourceName(), 'DiscordStatusEmbedThumbnail'))
			.setTimestamp()
			.setFooter({ text: 'This message was generated by cc-discordStatus', iconURL: 'https://conceptcollective.net/img/icon.png', URL: 'https://conceptcollective.net' });
		let playerCountNum = 0;
		let playerCount = [];
		let players = '**Currently Connected Player(s)**:\n';
		let nameString = '';
		await guildChannel.send({embeds: [statusEmbed]}).then(async sentMessage => {
			client.statusMessage = await sentMessage;
		});
		await updateChannelName(0)
		on('playerConnecting', (playerName, kickReason, deferrals) => {
			playerCountNum++;
			if (GetResourceMetadata(GetCurrentResourceName(), 'DiscordStatusPlayerNames') === 'true'){
				nameString = `â€£ ${playerName} - <@${GetPlayerIdentifier(source, 3).substring(8)}>`;
				playerCount.push(nameString)
				playerCount.forEach(player => {
					players += `${player}\n`;
				})
				updatePlayerNames(players, statusEmbed)
			} if (GetResourceMetadata(GetCurrentResourceName(), 'DiscordStatusChannelCount') !== 'false'){
				updateChannelName(playerCountNum)
			} else {
				statusEmbed.setDescription(`There are currently ${playerCountNum} players connected to the server!`)
			}
		})
		on('playerDropped', (reason) => {
			playerCountNum--;
			if (GetResourceMetadata(GetCurrentResourceName(), 'DiscordStatusPlayerNames') === 'true'){
				nameString = `â€£ ${GetPlayerName(source)} - <@${GetPlayerIdentifier(source, 3).substring(8)}>`;
				playerCount = playerCount.filter( e => e !== nameString);
				players = '**Currently Connected Player(s)**:\n';
				playerCount.forEach(player => {
					players += `${player}\n`;
				})
				updatePlayerNames(players, statusEmbed)
			} if (GetResourceMetadata(GetCurrentResourceName(), 'DiscordStatusChannelCount') !== 'false'){
				updateChannelName(playerCountNum)
			} else {
				statusEmbed.setDescription(`There are currently ${playerCount} players connected to the server!`)
			}
		})
		onNet('gameEventTriggered', (name, args) => {
			console.log(`Game event ${name} ${args.join(', ')}`)
		})

		async function updateChannelName(playerCountNum){
			const guildStatusChannel = client.channels.cache.get(await GetResourceMetadata(GetCurrentResourceName(), 'DiscordStatusChannelCount'));
			if (playerCountNum === 1){
				await guildStatusChannel.edit({ name: `ðŸ¦²ï½œ${playerCountNum}-player` });
			} else {
				await guildStatusChannel.edit({ name: `ðŸ¦²ï½œ${playerCountNum}-players` });
			}
		}

		function updatePlayerNames(players, statusEmbed) {
			if (players === '**Currently Connected Player(s)**:\n'){
				statusEmbed.setDescription('**There are currently no players connected!**');
			} else {
				statusEmbed.setDescription(players);
			};
			client.statusMessage.edit({embeds: [statusEmbed]});
		}
	},
};