const { Events } = require('discord.js');

module.exports = {
	name: Events.ClientReady,
	once: true,
	async execute(client) {
		console.log(`^2Ready! ^1Logged in as: ${client.user.tag}`);

		const serverGuild = await client.guilds.cache.get(client.config.General.serverID);
		const guildChannel = await client.channels.cache.get(client.config.DiscordBot.PlayerStatus.channelID);
		const guildStatusChannel = await client.channels.cache.get(client.config.DiscordBot.PlayerStatus.channelCountID);

		await guildChannel.bulkDelete(1).catch(e => console.warn('Failed to delete previous message - probably becuase there isn\'t one!'));
		let statusEmbed = new client.discord.EmbedBuilder()
			.setColor(0x0099FF)
			.setTitle(`${client.config.DiscordBot.PlayerStatus.embedConfig.title}`)
			.setURL(`${client.config.DiscordBot.PlayerStatus.embedConfig.url}`)
			.setAuthor({ name: `${client.user.username}`, iconURL: `${client.user.displayAvatarURL()}`, url: 'https://conceptcollective.net' })
			.setDescription('Server has been started âœ…')
			.setThumbnail(`${client.config.DiscordBot.PlayerStatus.embedConfig.thumbnail}`)
			.setTimestamp()
			.setFooter({ text: 'This message was generated by ccDiscordWrapper', iconURL: 'https://conceptcollective.net/img/icon.png', URL: 'https://conceptcollective.net' });
		let playerCountNum = 0;

		if (client.config.DiscordBot.PlayerStatus.channelCountID !== false){
			updateChannelName(playerCountNum)
		}
		let playerCount = [];
		let players = '**Currently Connected Player(s)**:\n';
		let nameString = '';
		await guildChannel.bulkDelete(1).catch(e => console.warn('Failed to delete previous message - probably becuase there isn\'t one!'));
		await guildChannel.send({embeds: [statusEmbed]}).then(async sentMessage => {
			client.statusMessage = await sentMessage;
		});
		on('playerJoining', async (source) => {
			if (client.config.DiscordBot.enabled === true) {
				let discordMember = await serverGuild.members.fetch(GetPlayerIdentifierByType(source, 'discord').substring(8))
				client.players[GetPlayerGuid(source)] = {
					id: discordMember.id,
					avatarURL: discordMember.user.avatarURL(),
					roles: discordMember.roles.cache.map(role => role.name),
					joinedAt: discordMember.joinedTimestamp,
					username: discordMember.user.username,
					nickname: discordMember.nickname
				}
			}
			let playerName = GetPlayerName(source);
			playerCountNum++;
			let playerActualDiscord = client.players[GetPlayerGuid(source)].id
			if (client.config.DiscordRPC.enabled === true) {
				emitNet("onServerConfigLoad", source, client.config)
			}
			if (client.config.DiscordBot.PlayerStatus.listPlayers === true){
				nameString = `â€£ ${playerName} - <@${playerActualDiscord}>`;
				playerCount.push(nameString)
				playerCount.forEach(player => {
					players += `${player}\n`;
				})
				updatePlayerNames(players, statusEmbed)
			} if (client.config.DiscordBot.PlayerStatus.channelCountID !== false){
				updateChannelName(playerCountNum)
			} else {
				statusEmbed.setDescription(`There are currently ${playerCountNum} players connected to the server!`)
			}
		})
		on('playerDropped', (reason) => {
			playerCountNum--;
			delete client.players[GetPlayerGuid(source)];
			let playerActualDiscord = GetPlayerIdentifierByType(source, 'discord').substring(8);
			if (client.config.DiscordBot.PlayerStatus.listPlayers === true){
				nameString = `â€£ ${GetPlayerName(source)} - <@${playerActualDiscord}>`;
				playerCount = playerCount.filter( e => e !== nameString);
				players = '**Currently Connected Player(s)**:\n';
				playerCount.forEach(player => {
					players += `${player}\n`;
				})
				updatePlayerNames(players, statusEmbed)
			} if (client.config.DiscordBot.PlayerStatus.channelCountID !== false){
				updateChannelName(playerCountNum)
			} else {
				statusEmbed.setDescription(`There are currently ${playerCount} players connected to the server!`)
			}
		})

		function updateChannelName(playerCountNumber){
			if (playerCountNumber === 1){
				guildStatusChannel.edit({ name: `ðŸ¦²ï½œ${playerCountNumber}-player` });
			} else {
				guildStatusChannel.edit({ name: `ðŸ¦²ï½œ${playerCountNumber}-players` });
			}
		}

		function updatePlayerNames(players, statusEmbed) {
			if (players === '**Currently Connected Player(s)**:\n'){
				statusEmbed.setDescription('**There are currently no players connected!**');
			} else {
				statusEmbed.setDescription(players);
			};
			client.statusMessage.edit({embeds: [statusEmbed]});
		}

	},
};